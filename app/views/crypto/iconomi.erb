<% balances = JSON.parse(Iconomi.get('/v1/user/balance'))['daaList'] %>
<% balanceTotal = balances.sum { |b| b['value'].to_i} %>
<% strategies = Strategy.active_mature.order('score_fee_weighted desc') %>
<% if funds = (params[:funds].try(:to_i) || (@p ? 3 : 5)) %>
  <% funds = 1 if funds < 1 %>
  <% funds = 10 if funds > 10 %>
  <% total = strategies[0..(funds-1)].sum { |strategy| strategy.score_fee_weighted } %>
  <% offset = 0 %>
  <% spin = 180/funds %>
<% end %>
<% investment = (params[:investment].try(:to_i) || (@p ? balanceTotal : 1000)) %>


<div class="text-center">
  <%= md :iconomi %>
</div>

<div class="row justify-content-center mb-3">
  <div class="col-md-6 col-lg-4 text-center">
    <% form_tag '', :method => 'get' do %>
      <label>Number of funds</label>
      <div class="range-slider">
        <input name="funds" class="range-slider__range" type="range" value="<%=funds%>" min="1" max="10" step="1" onchange="$(this.form).submit()">
        <span class="range-slider__value">0</span>
      </div>
      <label>Investment</label>
      <div class="row justify-content-center">
        <div class="col-auto">
          <div class="input-group" style="width: 10rem">
            <div class="input-group-prepend">
              <span class="input-group-text">$</span>
            </div>
            <%= number_field_tag :investment, :class => 'form-control-lg form-control', :value => investment, :onchange => '$(this.form).submit()' %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<div class="card mb-3 p-3">
  <div class="card-body text-center">
    <h5 class="card-title">Found this page useful?</h5>
    <p class="mb-0">
      Donate ETH: 0x72E1638bD8cD371Bfb04cF665b749A0E4ae38324
      <br />
      Donate BTC: 3E7TscgsiGNHdWJxJQC4XNEvhefhscMbB4
      <br />
      <a href="<%=ENV['CRYPTO_COURSE_URL']%>">Join my Introduction to Crypto & DeFi course</a>
    </p>
  </div>
</div>

<script>
  $(function () {
        $('#iconomi').dataTable({info: false, paging: false, searching: false, order: [[1, "desc"]]})
  })
</script>
<table id="iconomi" class="table" style="font-size: 0.9rem; border-collapse: collapse !important">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th>Score (fee weighted)</th>
      <% if @p %>
        <th colspan="2">Current position</th>
      <% end %>
      <th colspan="2">Proposed position</th>
      <% %w{numberOfAssets lastRebalanced monthlyRebalancedCount}.each { |x| %>
      <th><%=x%></th>
      <% } %>
      <th>24h</th>
      <th>7d</th>
      <th>1M</th>
      <th>3M</th>
      <th>6M</th>
      <th>1Y</th>
    </tr>
  </thead>
  <% strategies.each_with_index { |strategy, i| %>
  <tr>
    <td data-sort="<%=i+1%>">
      #<%=i+1%>
    </td>
    <td>
      <a target="_blank" href="https://my.iconomi.com/asset/<%=strategy.ticker%>"><%= strategy.name %></a>
      <% if !@p && strategy.name == 'Metastrategy' %>
        (private, <a href="mailto:stephen@stephenreid.net">ask me for an invitation</a>)
      <% end %>
    </td>
    <td data-sort="<%=strategy.score_fee_weighted%>">
      <% score, index = strategy.score_index('score_fee_weighted') %>
      <span class="score">
        <%= number_with_precision score, precision: 1 %>
      </span>
    </td>
    <% if @p %>
      <% f = balances.find { |b| b['ticker'] == strategy.ticker } %>
      <% v = f['value'] if f %>
      <% v = v.to_f if v %>
      <td>
        <% if v %>
          <%=number_to_percentage((v/balanceTotal)*100, :precision => 0)%>
        <% end %>
      </td>
      <td>
        <%= number_to_currency v, precision: 0 %>
      </td>
    <% end %>
    <td nowrap>
      <% if i < funds %>
        <%=number_to_percentage((strategy.score_fee_weighted/total)*100, :precision => 0)%>
        <% if @p %>
          <% if v %>
            <% d = strategy.score_fee_weighted/total - v/balanceTotal %>
            <% if (d*100).round != 0 %>
              <span style="color: <%= if d > 0; 'green'; elsif d < 0; 'red'; end %>">
                <%= '+' if d > 0 %><%=number_to_percentage(d*100, :precision => 0)%>
              </span>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    </td>
    <td>
      <% if i < funds %>
        <%= number_to_currency investment*(strategy.score_fee_weighted/total), precision: 0 %>
      <% end %>
    </td>
    <% %w{numberOfAssets lastRebalanced monthlyRebalancedCount}.each { |x| %>
    <td>
      <% if x == 'lastRebalanced' %>
        <%= time_ago_in_words strategy[x] %> ago
      <% else %>
        <%= strategy[x] %>
      <% end %>
    </td>
    <% } %>
    <% %w[day week month three_month six_month year].each { |t| %>
    <% if strategy.send(t) %>
      <% score, index = strategy.score_index(t) %>
      <td data-sort="<%=score%>">
        <span class="score">
          <%= number_with_precision score, precision: 1 %>
        </span>
        <br />
        <small>
          <%= index %>/<%=Strategy.active_mature.count%>
        </small>
      </td>
    <% else %>
      <td data-sort="0"></td>
    <% end %>
    <% } %>
  </tr>
  <% } %>
</table>

<%= partial :course %>
